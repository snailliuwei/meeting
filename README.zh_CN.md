# White——基于 Web 的广播白板系统

## 简介

White 的主要功能是，完全基于网页地，将一台终端上进行的绘图、视频播放、幻灯片放映等操作，实时地广播到其他的终端上，以实现一个功能较为全面的跨平台的一对多的电子白板系统。

## 设计思路

White 的基本设计思路是，一个终端进入系统后可以创建一个新的广播，广播创建后其他访问这个页面的访问者可以选择加入已有的某个广播或创建另一个新的广播。

整套系统分为3个部分：

1. **主机 (host)** 又称主持人，是广播的发起者，白板的所有操作都由主机进行；
2. **服务器 (server)** White 的服务器，负责保存主机上传的视频、幻灯片等文件，并将主机的操作转发给其他终端；
3. **听众 (audience)** 通过服务器接收主机的操作，并实时地反应在页面当中。

在同一个广播中的三个部分根据主机操作者的操作，各自维护白板的当前状态。

White 有三个工作模式：

1. **白板模式 (white)** 这个模式下屏幕显示为一张白板，主机操作者可以使用绘图工具在上面进行绘制；
2. **视频模式 (video)** 此模式用于播放视频，主机可以上传或选择已有视频并进行广播播放，同时可以任意地控制视频的播放、暂停和定位；
3. **幻灯片模式 (slide)** 此模式用于广播放映基于 HTML 的幻灯片，主机可以上传或选择已有的幻灯片文件包来广播放映幻灯片，控制幻灯片的页数，并可以在幻灯片上绘制注解。

## 实现技术

White 在服务器端使用了 Node.js 结合 express 框架和 connect 中间件处理 HTTP 请求，服务器端与浏览器页面之间的通讯使用 WebSocket，实现上使用了 Node.js 的库 Socket.io。

浏览器方面，白板模式和幻灯片模式下的绘图使用了 HTML5 的 `canvas` 标签以提供动态绘图接口；视频模式使用了 HTML5 的 `video` 标签进行视频播放和控制。

在视频播放的方面，由于视频文件通常较大，为了可以在上传时同步播放，我们自己开发了流缓冲的模块，以支持跨请求一对多的边上传边下载技术。

## 如何使用

安装 Node.js 后还需要如下库：

* [mkdirp](https://npmjs.org/package/mkdirp) - 递归创建文件夹
* [rimraf](https://npmjs.org/package/rimraf) - 删除文件夹
* [express](https://npmjs.org/package/express) - 网站框架，主要使用其路由功能
* [socket.io](https://npmjs.org/package/socket.io) - 浏览器与服务器间通讯
* [range-parser](https://npmjs.org/package/range-parser) - 用于解析部分内容请求

直接使用如下命令安装：

	npm install mkdirp rimraf express socket.io range-parser
	
而后在 src 目录中使用下面命令启动：

	node app.js

启动后通过浏览器访问 `http://localhost:8080/` 即可。

## 计划中的功能

由于开发时间较短，最初设计中的部分功能未有完全实现，在之后的开发过程中也又提出了一些新的功能的想法，这些功能的实现目前仍在计划中：

1. **边上传边播放** 设计中想要使用缓冲流模块实现主机边上传，观众边下载的功能，以在上传视频时可以不需要等待视频上传完成就可以开始播放。但由于播放器有时会优先请求文件末尾，使得这一功能可能达不到预期的效果，尚待继续观察测试。
2. **文字和图片** 最初的设想中在白板模式和幻灯片模式下除了可以使用画笔绘图外还可以添加文字和自定义的图片，但由于设计上还需要更多的考虑，因此尚未实现；
3. **多白板** 原本计划中支持不止一个白板，并可以在白板之间随意切换，在没有人为清理的情况下不会清楚任何白板内容，由于实现复杂，该功能在开发过程中被去掉；
4. **显示听众数** 计划中主机可以实时看到当前的听众数量，这一点在服务器端已经完成但由于界面设计局限性，尚未被加入到浏览器端；
5. **视频音量调节** 广播音量调节在理论上是可行的，但也暂时未在系统中实现；
6. **视频标注** 即在播放视频的过程中像播放幻灯片时一样可以进行标注；
7. **多点绘图** 在支持多点触控的终端上支持多个手指同时绘图；
8. **保存记录** 在需要的情况下，服务器端可以保存并重现整个广播过程。

## 局限性

由于技术上和实现上的限制，本系统尚有一些局限性：

1. **视频格式限制** 目前 White 仅设计支持 video/mp4 格式的视频，并将其硬编码到代码中，对于不支持 mp4 格式的浏览器，将无法播放视频；
2. **幻灯片限制** 由于跨浏览器的排版和渲染问题，并非所有的 HTML 幻灯片框架都能很好地支持，事实上所有的幻灯片框架都必须经过适当的调整才能在本系统中使用，系统希望幻灯片自己能在不同的长宽下保持内容的等比例缩放，以保证在幻灯片上进行的绘图操作可以在听众的屏幕上与主机保持一直；
3. **幻灯片包格式** 目前仅支持 .zip 的幻灯片压缩包，并且要求包内要有 index.html 文件位于根目录下；
4. **iPad 下的视频** 由于 iOS 中的 Safari Mobile 浏览器对 `video` 的实现限制，在 iPad 下使用本系统还有额外的问题：
	1. 由于 iOS 中如果用户不点击视频则视频不能进行缓冲或播放，因此 iPad 无法作为听众端接收视频广播；
	2. 由于 iPad 中位于视频元素上方的任何元素无法被点击，因此在视频模式下无法切换视频或进入幻灯片模式，要进行上述操作必须先切换回白板模式。
5. **样式未全 CSS 化** 主机界面还未能完全 CSS 化，很多部件的定位是由脚本程序完成的，这使得改变窗口大小时会有一定的性能减损。
